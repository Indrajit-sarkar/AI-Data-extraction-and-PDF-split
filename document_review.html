<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Review & Verification</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* TRON LEGACY THEME - Same as index.html */
            --tron-cyan: #00d4ff;
            --tron-cyan-dim: rgba(0, 212, 255, 0.25);
            --tron-cyan-glow: rgba(0, 212, 255, 0.5);
            --tron-orange: #ff6600;
            --tron-dark: #0a0a0f;
            --tron-darker: #050508;

            /* Liquid Glass with Tron glow */
            --clear-glass: rgba(0, 20, 30, 0.6);
            --clear-glass-hover: rgba(0, 40, 60, 0.7);
            --clear-glass-border: rgba(0, 212, 255, 0.4);
            --blur-amount: 20px;

            --text-primary: rgba(255, 255, 255, 0.95);
            --text-secondary: rgba(0, 212, 255, 0.7);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        html,
        body {
            height: 100%;
            font-family: 'Inter', -apple-system, sans-serif;
            background: #000000;
            color: var(--text-primary);
            overflow: hidden;
        }

        /* ============================================
           STARTUP LOADING OVERLAY
           ============================================ */
        .startup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background:
                repeating-linear-gradient(0deg, transparent, transparent 40px, rgba(0, 212, 255, 0.08) 40px, rgba(0, 212, 255, 0.08) 41px),
                repeating-linear-gradient(90deg, transparent, transparent 40px, rgba(0, 212, 255, 0.08) 40px, rgba(0, 212, 255, 0.08) 41px),
                radial-gradient(ellipse at center, rgba(0, 40, 60, 0.4) 0%, #000000 70%);
            transition: opacity 0.8s ease, visibility 0.8s ease;
        }

        .startup-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .startup-title {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(32px, 5vw, 56px);
            font-weight: 700;
            color: var(--tron-cyan);
            text-shadow: 0 0 20px var(--tron-cyan), 0 0 40px var(--tron-cyan);
            letter-spacing: 4px;
            animation: titlePulse 2s ease-in-out infinite;
            margin-bottom: 30px;
            text-align: center;
        }

        @keyframes titlePulse {

            0%,
            100% {
                text-shadow: 0 0 20px var(--tron-cyan), 0 0 40px var(--tron-cyan);
            }

            50% {
                text-shadow: 0 0 40px var(--tron-cyan), 0 0 80px var(--tron-cyan-glow);
            }
        }

        .startup-loading {
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            color: var(--tron-cyan);
            letter-spacing: 8px;
            margin-bottom: 25px;
            animation: loadingBlink 0.8s step-end infinite;
        }

        @keyframes loadingBlink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0.3;
            }
        }

        .startup-progress {
            width: 300px;
            max-width: 80%;
            height: 6px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--tron-cyan-dim);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 40px;
        }

        .startup-progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--tron-cyan), #00ffaa);
            box-shadow: 0 0 15px var(--tron-cyan);
            transition: width 0.2s ease;
        }

        .startup-start-btn {
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            font-weight: 600;
            padding: 14px 45px;
            background: transparent;
            border: 2px solid var(--tron-cyan);
            color: var(--tron-cyan);
            cursor: pointer;
            letter-spacing: 6px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .startup-start-btn.visible {
            opacity: 1;
            visibility: visible;
            animation: btnPulse 1.5s ease-in-out infinite;
        }

        .startup-start-btn:hover {
            background: var(--tron-cyan);
            color: #000;
            box-shadow: 0 0 30px var(--tron-cyan);
        }

        @keyframes btnPulse {

            0%,
            100% {
                box-shadow: 0 0 10px var(--tron-cyan-dim);
            }

            50% {
                box-shadow: 0 0 25px var(--tron-cyan);
            }
        }

        /* ============================================
           TRON ANIMATED BACKGROUND
           ============================================ */
        .landscape-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background:
                repeating-linear-gradient(0deg, transparent, transparent 80px, rgba(0, 212, 255, 0.03) 80px, rgba(0, 212, 255, 0.03) 81px),
                repeating-linear-gradient(90deg, transparent, transparent 80px, rgba(0, 212, 255, 0.03) 80px, rgba(0, 212, 255, 0.03) 81px),
                radial-gradient(ellipse at center bottom, rgba(0, 40, 60, 0.3) 0%, #000000 70%);
        }

        .aura-light {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            animation: auraFloat 12s ease-in-out infinite;
            pointer-events: none;
        }

        .aura-1 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(0, 212, 255, 0.2) 0%, transparent 70%);
            top: 10%;
            left: 5%;
        }

        .aura-2 {
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(0, 180, 220, 0.2) 0%, transparent 70%);
            bottom: 15%;
            right: 8%;
            animation-delay: -4s;
        }

        @keyframes auraFloat {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.6;
            }

            50% {
                transform: translate(20px, -20px) scale(1.1);
                opacity: 0.8;
            }
        }

        /* ============================================
           MAIN APPLICATION
           ============================================ */
        .app-container {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            opacity: 0;
            transition: opacity 0.6s ease;
        }

        .app-container.visible {
            opacity: 1;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            background: var(--clear-glass);
            backdrop-filter: blur(var(--blur-amount));
            border-bottom: 1px solid var(--clear-glass-border);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .back-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--clear-glass-border);
            color: var(--text-secondary);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: var(--tron-cyan-dim);
            color: var(--tron-cyan);
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: var(--tron-cyan);
        }

        .doc-info {
            font-size: 12px;
            color: var(--text-secondary);
            padding: 5px 12px;
            background: var(--clear-glass);
            border: 1px solid var(--clear-glass-border);
            border-radius: 16px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--clear-glass-border);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--tron-cyan);
            color: #000;
            border: none;
        }

        .btn-primary:hover {
            box-shadow: 0 0 15px var(--tron-cyan-glow);
        }

        .btn-success {
            background: rgba(52, 199, 89, 0.2);
            color: #34C759;
            border-color: rgba(52, 199, 89, 0.4);
        }

        .btn-danger {
            background: rgba(255, 59, 48, 0.2);
            color: #FF3B30;
            border-color: rgba(255, 59, 48, 0.4);
        }

        /* Main Content - Two Panes */
        .main-content {
            flex: 1;
            display: flex;
            gap: 16px;
            padding: 16px;
            min-height: 0;
        }

        /* Left Pane - Extracted Fields */
        .fields-pane {
            flex: 0 0 40%;
            display: flex;
            flex-direction: column;
            background: var(--clear-glass);
            backdrop-filter: blur(var(--blur-amount));
            border: 1px solid var(--clear-glass-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            min-height: 0;
        }

        .pane-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--clear-glass-border);
            background: rgba(0, 0, 0, 0.3);
        }

        .pane-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Detailed Statistics Bar */
        .stats-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 10px 14px;
            background: rgba(0, 0, 0, 0.4);
            border-bottom: 1px solid var(--clear-glass-border);
        }

        .stat-item {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-total {
            background: rgba(0, 212, 255, 0.2);
            color: var(--tron-cyan);
        }

        .stat-null {
            background: rgba(255, 149, 0, 0.2);
            color: #FF9500;
        }

        .stat-high {
            background: rgba(52, 199, 89, 0.2);
            color: #34C759;
        }

        .stat-medium {
            background: rgba(255, 204, 0, 0.2);
            color: #FFCC00;
        }

        .stat-low {
            background: rgba(255, 59, 48, 0.2);
            color: #FF3B30;
        }

        /* Single Consolidated Fields Card */
        .fields-card {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            min-height: 0;
        }

        .fields-card::-webkit-scrollbar {
            width: 8px;
        }

        .fields-card::-webkit-scrollbar-thumb {
            background: var(--tron-cyan-dim);
            border-radius: 4px;
        }

        .field-row {
            display: flex;
            align-items: flex-start;
            padding: 10px 12px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .field-row:hover {
            background: rgba(0, 212, 255, 0.25);
            border-left: 4px solid var(--tron-cyan);
        }

        .field-row.active {
            background: rgba(0, 212, 255, 0.35);
            border-left: 5px solid var(--tron-cyan);
            box-shadow: inset 0 0 20px rgba(0, 212, 255, 0.3), 0 0 10px rgba(0, 212, 255, 0.2);
        }

        .field-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--tron-cyan);
            min-width: 140px;
            max-width: 160px;
            word-break: break-word;
        }

        .field-value {
            flex: 1;
            font-size: 12px;
            color: var(--text-primary);
            margin-left: 12px;
            word-break: break-word;
        }

        .field-confidence {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 600;
            margin-left: 8px;
            white-space: nowrap;
        }

        .conf-high {
            background: rgba(52, 199, 89, 0.3);
            color: #34C759;
        }

        .conf-medium {
            background: rgba(255, 204, 0, 0.3);
            color: #FFCC00;
        }

        .conf-low {
            background: rgba(255, 59, 48, 0.3);
            color: #FF3B30;
        }

        .field-actions {
            display: flex;
            gap: 4px;
            margin-left: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .field-row:hover .field-actions {
            opacity: 1;
        }

        .action-btn {
            width: 22px;
            height: 22px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            background: var(--tron-cyan-dim);
            color: var(--tron-cyan);
        }

        /* Right Pane - Document Preview */
        .document-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--clear-glass);
            backdrop-filter: blur(var(--blur-amount));
            border: 1px solid var(--clear-glass-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            min-height: 0;
        }

        /* Browser-like PDF Viewport */
        .document-viewport {
            flex: 1;
            overflow: auto;
            background: rgba(10, 14, 20, 0.8);
            position: relative;
            min-height: 0;
        }

        .document-viewport::-webkit-scrollbar {
            width: 14px;
            background: #2A2A2E;
        }

        .document-viewport::-webkit-scrollbar-thumb {
            background: #777;
            border: 4px solid #2A2A2E;
            border-radius: 8px;
        }

        /* PDF Pages Container */
        .pages-container {
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .page-wrapper {
            background: white;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4), 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .page-wrapper canvas {
            display: block;
        }

        /* Text Layer for Find functionality */
        .text-layer {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            opacity: 0.2;
            line-height: 1.0;
        }

        .text-layer span {
            color: transparent;
            position: absolute;
            white-space: pre;
            transform-origin: 0% 0%;
        }

        .text-layer .highlight {
            background: rgba(0, 212, 255, 0.5);
            color: transparent;
        }

        /* Search Highlight */
        .search-highlight {
            position: absolute;
            background: rgba(255, 255, 0, 0.4);
            border: 2px solid rgba(255, 150, 0, 0.8);
            border-radius: 2px;
            pointer-events: none;
            animation: highlightPulse 1.5s ease-in-out infinite;
            z-index: 100;
            mix-blend-mode: multiply;
        }

        @keyframes highlightPulse {

            0%,
            100% {
                box-shadow: 0 0 10px var(--tron-cyan);
            }

            50% {
                box-shadow: 0 0 30px var(--tron-cyan), 0 0 50px var(--tron-cyan-glow);
            }
        }

        .page-indicator {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--clear-glass);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--clear-glass-border);
            font-size: 12px;
            color: var(--tron-cyan);
            z-index: 100;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            gap: 16px;
            padding: 40px;
        }

        .empty-icon {
            font-size: 64px;
            opacity: 0.4;
        }

        /* Browse Files Button - Transparent Glass Style */
        .browse-files-btn {
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
            padding: 16px 32px;
            background: rgba(0, 212, 255, 0.05);
            border: 2px solid var(--tron-cyan);
            border-radius: 8px;
            color: var(--tron-cyan);
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 0 10px var(--tron-cyan);
            backdrop-filter: blur(5px);
        }

        .browse-files-btn:hover {
            background: rgba(0, 212, 255, 0.15);
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.4), inset 0 0 20px rgba(0, 212, 255, 0.1);
            transform: scale(1.05);
        }

        .browse-files-btn:active {
            transform: scale(0.98);
        }

        /* Azure Storage Modal */
        .azure-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .azure-modal-overlay.active {
            display: flex;
        }

        .azure-modal {
            background: rgba(10, 25, 35, 0.95);
            border: 1px solid var(--tron-cyan-dim);
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(0, 212, 255, 0.3);
        }

        .azure-modal-header {
            padding: 16px 20px;
            background: rgba(0, 212, 255, 0.1);
            border-bottom: 1px solid var(--tron-cyan-dim);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .azure-modal-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            color: var(--tron-cyan);
        }

        .azure-modal-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .azure-modal-close:hover {
            color: var(--tron-orange);
        }

        .azure-modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .azure-container-select {
            margin-bottom: 16px;
        }

        .azure-container-select label {
            display: block;
            margin-bottom: 8px;
            color: var(--tron-cyan);
            font-size: 12px;
        }

        .azure-container-select select {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--tron-cyan-dim);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .azure-file-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--tron-cyan-dim);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
        }

        .azure-file-item {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .azure-file-item:hover {
            background: rgba(0, 212, 255, 0.1);
        }

        .azure-file-item.selected {
            background: rgba(0, 212, 255, 0.2);
            border-left: 3px solid var(--tron-cyan);
        }

        .azure-file-icon {
            font-size: 20px;
        }

        .azure-file-name {
            flex: 1;
            color: var(--text-primary);
        }

        .azure-file-size {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .azure-modal-footer {
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid var(--tron-cyan-dim);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .azure-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--tron-cyan);
        }

        .azure-loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid var(--tron-cyan-dim);
            border-top-color: var(--tron-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ============================================
           EMAIL PREVIEW STYLES
           ============================================ */
        .email-preview {
            padding: 20px;
            max-width: 100%;
        }

        .email-header {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--tron-cyan-dim);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .email-header-row {
            display: flex;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .email-header-label {
            color: var(--tron-cyan);
            font-weight: 600;
            min-width: 70px;
            flex-shrink: 0;
        }

        .email-header-value {
            color: var(--text-primary);
            word-break: break-word;
        }

        .email-subject {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--tron-cyan-dim);
        }

        .email-body {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--clear-glass-border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            color: var(--text-primary);
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }

        .email-body-html {
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 6px;
        }

        .email-body-text {
            white-space: pre-wrap;
            font-family: inherit;
        }

        /* Attachment List */
        .attachments-section {
            margin-top: 20px;
        }

        .attachments-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            color: var(--tron-cyan);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .attachment-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .attachment-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid var(--tron-cyan-dim);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            gap: 12px;
        }

        .attachment-item:hover {
            background: rgba(0, 212, 255, 0.15);
            transform: translateX(4px);
        }

        .attachment-item.active {
            background: rgba(0, 212, 255, 0.2);
            border-color: var(--tron-cyan);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        .attachment-icon {
            font-size: 24px;
        }

        .attachment-info {
            flex: 1;
        }

        .attachment-name {
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 500;
        }

        .attachment-meta {
            color: var(--text-secondary);
            font-size: 11px;
            margin-top: 2px;
        }

        .attachment-actions {
            display: flex;
            gap: 8px;
        }

        .attachment-btn {
            padding: 6px 12px;
            font-size: 11px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--tron-cyan-dim);
            border-radius: 4px;
            color: var(--tron-cyan);
            cursor: pointer;
            transition: all 0.2s;
        }

        .attachment-btn:hover {
            background: rgba(0, 212, 255, 0.2);
        }

        /* Inline Attachment Preview */
        .attachment-preview-container {
            margin-top: 16px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--tron-cyan-dim);
            border-radius: 8px;
            overflow: hidden;
        }

        .attachment-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(0, 212, 255, 0.1);
            border-bottom: 1px solid var(--tron-cyan-dim);
        }

        .attachment-preview-title {
            color: var(--tron-cyan);
            font-size: 13px;
            font-weight: 500;
        }

        .attachment-preview-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
        }

        .attachment-preview-content {
            padding: 16px;
            max-height: 500px;
            overflow: auto;
        }

        .attachment-preview-content img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }

        .attachment-preview-content iframe {
            width: 100%;
            height: 400px;
            border: none;
            border-radius: 4px;
            background: white;
        }

        /* Document Type Previews */
        .docx-content,
        .excel-content,
        .csv-content {
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            border-radius: 8px;
            font-family: 'Segoe UI', Arial, sans-serif;
            line-height: 1.6;
        }

        .docx-content h1 {
            font-size: 24px;
            margin: 16px 0;
            color: #1a1a1a;
        }

        .docx-content h2 {
            font-size: 20px;
            margin: 14px 0;
            color: #333;
        }

        .docx-content h3 {
            font-size: 16px;
            margin: 12px 0;
            color: #444;
        }

        .docx-content p {
            margin: 8px 0;
        }

        .docx-table,
        .excel-table,
        .csv-table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            font-size: 13px;
        }

        .docx-table td,
        .docx-table th,
        .excel-table td,
        .excel-table th,
        .csv-table td,
        .csv-table th {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }

        .excel-table th,
        .csv-table th {
            background: #f0f0f0;
            font-weight: 600;
        }

        .excel-table tr:nth-child(even),
        .csv-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .sheet-name {
            color: #0078D4;
            font-size: 16px;
            margin: 20px 0 10px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #0078D4;
        }

        /* Status Bar */
        .status-bar {
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.5);
            border-top: 1px solid var(--clear-glass-border);
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--tron-cyan);
            animation: statusPulse 2s infinite;
        }

        @keyframes statusPulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }
    </style>
</head>

<body>
    <!-- Startup Loading Overlay -->
    <div class="startup-overlay" id="startupOverlay">
        <div class="startup-title">DOCUMENT REVIEW</div>
        <div class="startup-loading" id="loadingText">INITIALIZING...</div>
        <div class="startup-progress">
            <div class="startup-progress-bar" id="progressBar"></div>
        </div>
        <button class="startup-start-btn" id="startBtn">START</button>
    </div>

    <!-- TRON Background -->
    <div class="landscape-bg">
        <div class="aura-light aura-1"></div>
        <div class="aura-light aura-2"></div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="back-btn" onclick="window.location.href='/'">‚Üê Back</button>
                <span class="logo">Document Review</span>
                <span class="doc-info" id="docInfo">No document loaded</span>
            </div>
            <div class="header-actions">
                <button class="btn" onclick="window.location.href='/settings'"
                    style="background: var(--tron-cyan-dim); border-color: var(--tron-cyan); color: var(--tron-cyan);">‚öôÔ∏è
                    Settings</button>
                <button class="btn btn-primary" id="uploadBtn">üìÅ Upload</button>
                <button class="btn" id="azureStorageBtn"
                    style="background: linear-gradient(135deg, rgba(0, 120, 212, 0.2), rgba(0, 120, 212, 0.1)); border-color: rgba(0, 120, 212, 0.5); color: #0078D4;">‚òÅÔ∏è
                    Azure Storage</button>
                <button class="btn btn-primary" id="extractBtn">‚ö° Extract Fields</button>
                <button class="btn btn-success" id="approveBtn">‚úì Approve</button>
                <button class="btn btn-danger" id="rejectBtn">‚úï Reject</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Left Pane - Extracted Fields (Single Card) -->
            <div class="fields-pane">
                <div class="pane-header">
                    <div class="pane-title">üìã Extracted Fields</div>
                    <button class="btn" style="padding: 4px 10px; font-size: 11px;" onclick="addNewField()">+
                        Add</button>
                </div>
                <!-- Detailed Statistics -->
                <div class="stats-bar" id="statsBar">
                    <span class="stat-item stat-total">Total Fields: <strong id="statTotal">0</strong></span>
                    <span class="stat-item stat-null">Null Fields: <strong id="statNull">0</strong></span>
                    <span class="stat-item stat-high">‚â•95% Confidence: <strong id="statHigh">0</strong></span>
                    <span class="stat-item stat-medium">80-94%: <strong id="statMedium">0</strong></span>
                    <span class="stat-item stat-low">&lt;80%: <strong id="statLow">0</strong></span>
                </div>
                <!-- Single Card with all fields -->
                <div class="fields-card" id="fieldsCard">
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <div>No fields extracted yet</div>
                        <div style="font-size: 11px;">Upload a document and click Extract</div>
                    </div>
                </div>
            </div>

            <!-- Right Pane - Document Preview -->
            <div class="document-pane">
                <div class="pane-header">
                    <div class="pane-title">üìÑ Document Preview</div>
                    <span id="pageIndicatorHeader" style="font-size: 12px; color: var(--tron-cyan);"></span>
                </div>
                <div class="document-viewport" id="documentViewport">
                    <div class="empty-state" id="previewEmptyState">
                        <div class="empty-icon">üìÑ</div>
                        <button class="browse-files-btn" id="browseFilesBtn"
                            onclick="document.getElementById('fileInput').click()">
                            üìÇ Browse Files
                        </button>
                        <div style="font-size: 11px; margin-top: 8px; opacity: 0.7;">or drag and drop files here</div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Status Bar -->
        <footer class="status-bar">
            <div class="status-left">
                <div class="status-indicator"></div>
                <span id="statusText">Ready</span>
            </div>
            <div id="statusRight"></div>
        </footer>
    </div>

    <!-- Azure Storage Modal -->
    <div class="azure-modal-overlay" id="azureModal">
        <div class="azure-modal">
            <div class="azure-modal-header">
                <span class="azure-modal-title">‚òÅÔ∏è Azure Blob Storage</span>
                <button class="azure-modal-close" onclick="closeAzureModal()">√ó</button>
            </div>
            <div class="azure-modal-body" id="azureModalBody">
                <div class="azure-loading" id="azureLoading">
                    <div class="azure-loading-spinner"></div>
                    <span>Loading containers...</span>
                </div>
                <div id="azureContent" style="display: none;">
                    <div class="azure-container-select">
                        <label>SELECT CONTAINER</label>
                        <select id="containerSelect" onchange="loadContainerBlobs()">
                            <option value="">-- Select a container --</option>
                        </select>
                    </div>
                    <div class="azure-file-list" id="blobList">
                        <div style="padding: 20px; text-align: center; color: var(--text-secondary);">
                            Select a container to view files
                        </div>
                    </div>
                </div>
                <div id="azureError"
                    style="display: none; padding: 20px; color: var(--tron-orange); text-align: center;"></div>
            </div>
            <div class="azure-modal-footer">
                <span id="selectedFileInfo" style="color: var(--text-secondary); font-size: 12px;">No file
                    selected</span>
                <button class="btn btn-primary" id="loadAzureFileBtn" disabled onclick="loadSelectedAzureFile()">üì• Load
                    File</button>
            </div>
        </div>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="fileInput" accept=".pdf,.docx,.xlsx,.eml,.csv,.png,.jpg,.jpeg" style="display: none;">

    <script>
        // PDF.js configuration
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // State
        let currentFile = null;
        let extractedFields = {};
        let pdfDoc = null;
        let pdfScale = 1.3;
        let currentDocIndex = 0;

        // DOM Elements
        const startupOverlay = document.getElementById('startupOverlay');
        const progressBar = document.getElementById('progressBar');
        const loadingText = document.getElementById('loadingText');
        const startBtn = document.getElementById('startBtn');
        const appContainer = document.getElementById('appContainer');
        const docInfo = document.getElementById('docInfo');
        const documentViewport = document.getElementById('documentViewport');
        const fieldsCard = document.getElementById('fieldsCard');
        const statusText = document.getElementById('statusText');

        // ============================================
        // STARTUP ANIMATION
        // ============================================
        function runStartupSequence() {
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15 + 8;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    loadingText.textContent = 'READY';
                    startBtn.classList.add('visible');
                }
                progressBar.style.width = progress + '%';
            }, 150);
        }

        startBtn.addEventListener('click', () => {
            startupOverlay.classList.add('hidden');
            appContainer.classList.add('visible');
        });

        // ============================================
        // FILE UPLOAD
        // ============================================
        document.getElementById('uploadBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            currentFile = file;
            docInfo.textContent = file.name;
            setStatus(`Loading ${file.name}...`);

            // Upload to server using /api/review/add endpoint
            const formData = new FormData();
            formData.append('files', file);  // Backend expects 'files' field

            try {
                const response = await fetch('/api/review/add', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.success) {
                    // Track the index (last added document)
                    currentDocIndex = (data.total || 1) - 1;
                    setStatus(`Loaded: ${file.name} (index ${currentDocIndex})`);
                    // Load preview
                    await loadDocumentPreview(file);
                } else {
                    setStatus(`Error: ${data.error}`);
                    await loadDocumentPreview(file);
                }
            } catch (error) {
                setStatus(`Upload error: ${error.message}`);
                // Still try to preview locally
                await loadDocumentPreview(file);
            }
        });

        // ============================================
        // DOCUMENT PREVIEW - Full Scrollable
        // ============================================
        let currentEmlCache = null; // Store EML cache key for attachment access
        let currentAttachments = []; // Store attachments list

        async function loadDocumentPreview(file) {
            const fileType = file.name.split('.').pop().toLowerCase();

            if (fileType === 'pdf') {
                await loadPDFPreview(file);
            } else if (['png', 'jpg', 'jpeg', 'gif'].includes(fileType)) {
                loadImagePreview(file);
            } else if (['eml', 'docx', 'xlsx', 'xls', 'csv'].includes(fileType)) {
                // Parse via backend API
                await loadParsedPreview(file, fileType);
            } else {
                loadGenericPreview(file, fileType);
            }
        }

        async function loadPDFPreview(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const totalPages = pdfDoc.numPages;

                // Create pages container
                documentViewport.innerHTML = '<div class="pages-container" id="pagesContainer"></div>';
                const pagesContainer = document.getElementById('pagesContainer');

                // Render ALL pages
                for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                    const page = await pdfDoc.getPage(pageNum);
                    const viewport = page.getViewport({ scale: pdfScale });

                    // Page wrapper
                    const wrapper = document.createElement('div');
                    wrapper.className = 'page-wrapper';
                    wrapper.id = `page-${pageNum}`;
                    wrapper.style.width = viewport.width + 'px';
                    wrapper.style.height = viewport.height + 'px';

                    // Canvas for rendering
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;

                    // Render page
                    const context = canvas.getContext('2d');
                    await page.render({ canvasContext: context, viewport: viewport }).promise;

                    // Text layer for find functionality
                    const textLayer = document.createElement('div');
                    textLayer.className = 'text-layer';
                    textLayer.style.width = viewport.width + 'px';
                    textLayer.style.height = viewport.height + 'px';

                    // Get text content
                    const textContent = await page.getTextContent();
                    textContent.items.forEach(item => {
                        const span = document.createElement('span');
                        span.textContent = item.str;
                        const x = item.transform[4] * pdfScale;
                        const y = viewport.height - (item.transform[5] * pdfScale) - (item.height * pdfScale);
                        span.style.left = x + 'px';
                        span.style.top = y + 'px';
                        span.style.fontSize = (item.height * pdfScale) + 'px';
                        span.dataset.text = item.str.toLowerCase();
                        textLayer.appendChild(span);
                    });

                    wrapper.appendChild(canvas);
                    wrapper.appendChild(textLayer);
                    pagesContainer.appendChild(wrapper);
                }

                document.getElementById('pageIndicatorHeader').textContent = `${totalPages} page${totalPages > 1 ? 's' : ''}`;
                documentViewport.addEventListener('scroll', updatePageIndicator);
                setStatus(`Loaded ${totalPages} page${totalPages > 1 ? 's' : ''}`);

            } catch (error) {
                console.error('PDF load error:', error);
                setStatus(`Error loading PDF: ${error.message}`);
            }
        }

        function loadImagePreview(file) {
            const url = URL.createObjectURL(file);
            documentViewport.innerHTML = `
                <div class="pages-container">
                    <div class="page-wrapper" style="max-width: 100%;">
                        <img src="${url}" style="max-width: 100%; height: auto;" alt="Document Preview">
                    </div>
                </div>`;
            document.getElementById('pageIndicatorHeader').textContent = 'Image';
            setStatus('Image loaded');
        }

        async function loadParsedPreview(file, fileType) {
            setStatus(`Parsing ${file.name}...`);

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/preview/parse', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to parse file');
                }

                switch (data.type) {
                    case 'eml':
                        loadEMLPreview(data);
                        break;
                    case 'docx':
                    case 'xlsx':
                    case 'csv':
                        loadParsedDocumentPreview(data);
                        break;
                    default:
                        loadGenericPreview(file, fileType);
                }
            } catch (error) {
                console.error('Parse error:', error);
                setStatus(`Error: ${error.message}`);
                loadGenericPreview(file, fileType);
            }
        }

        function loadEMLPreview(data) {
            currentEmlCache = data.cacheKey;
            currentAttachments = data.attachments || [];

            const headers = data.headers;
            const hasAttachments = currentAttachments.length > 0;

            // Build email preview HTML
            let html = `
                <div class="email-preview">
                    <div class="email-header">
                        <div class="email-header-row">
                            <span class="email-header-label">From:</span>
                            <span class="email-header-value">${escapeHtml(headers.from)}</span>
                        </div>
                        <div class="email-header-row">
                            <span class="email-header-label">To:</span>
                            <span class="email-header-value">${escapeHtml(headers.to)}</span>
                        </div>
                        ${headers.cc ? `
                        <div class="email-header-row">
                            <span class="email-header-label">CC:</span>
                            <span class="email-header-value">${escapeHtml(headers.cc)}</span>
                        </div>` : ''}
                        <div class="email-header-row">
                            <span class="email-header-label">Date:</span>
                            <span class="email-header-value">${escapeHtml(headers.date)}</span>
                        </div>
                        <div class="email-subject">üìß ${escapeHtml(headers.subject)}</div>
                    </div>
                    
                    <div class="email-body">
                        ${data.bodyHtml ?
                    `<div class="email-body-html">${data.bodyHtml}</div>` :
                    `<div class="email-body-text">${escapeHtml(data.bodyText || 'No content')}</div>`
                }
                    </div>`;

            // Add attachments section
            if (hasAttachments) {
                html += `
                    <div class="attachments-section">
                        <div class="attachments-title">üìé Attachments (${currentAttachments.length})</div>
                        <div class="attachment-list">
                            ${currentAttachments.map((att, idx) => `
                                <div class="attachment-item" onclick="previewAttachment(${idx})" data-index="${idx}">
                                    <span class="attachment-icon">${getAttachmentIcon(att.filename)}</span>
                                    <div class="attachment-info">
                                        <div class="attachment-name">${escapeHtml(att.filename)}</div>
                                        <div class="attachment-meta">${formatFileSize(att.size)} ‚Ä¢ ${att.contentType}</div>
                                    </div>
                                    <div class="attachment-actions">
                                        <button class="attachment-btn" onclick="event.stopPropagation(); downloadAttachment(${idx})">‚¨á Download</button>
                                        <button class="attachment-btn" onclick="event.stopPropagation(); previewAttachment(${idx})">üëÅ Preview</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div id="attachmentPreviewArea"></div>
                    </div>`;
            }

            html += '</div>';
            documentViewport.innerHTML = html;

            const attachmentCount = hasAttachments ? ` + ${currentAttachments.length} attachments` : '';
            document.getElementById('pageIndicatorHeader').textContent = `EML${attachmentCount}`;
            setStatus(`Email loaded with ${currentAttachments.length} attachment(s)`);
        }

        function loadParsedDocumentPreview(data) {
            documentViewport.innerHTML = `
                <div class="pages-container">
                    <div class="page-wrapper" style="max-width: 100%; padding: 20px;">
                        ${data.html}
                    </div>
                </div>`;
            document.getElementById('pageIndicatorHeader').textContent = data.type.toUpperCase();
            setStatus(`${data.type.toUpperCase()} preview loaded`);
        }

        function loadGenericPreview(file, fileType) {
            documentViewport.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üìÑ</div>
                    <div>${file.name}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">
                        ${fileType.toUpperCase()} files are processed for extraction but not previewed.
                    </div>
                </div>`;
            document.getElementById('pageIndicatorHeader').textContent = fileType.toUpperCase();
        }

        // ============================================
        // ATTACHMENT PREVIEW/DOWNLOAD
        // ============================================
        async function previewAttachment(index) {
            if (!currentEmlCache || !currentAttachments[index]) return;

            const att = currentAttachments[index];
            const contentType = att.contentType.toLowerCase();
            const filename = att.filename;
            const ext = filename.split('.').pop().toLowerCase();

            // Highlight selected attachment
            document.querySelectorAll('.attachment-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.attachment-item[data-index="${index}"]`)?.classList.add('active');

            const previewArea = document.getElementById('attachmentPreviewArea');
            const attachmentUrl = `/api/preview/attachment/${currentEmlCache}/${index}`;

            let previewContent = '';

            // Determine preview type
            if (contentType.includes('image') || ['png', 'jpg', 'jpeg', 'gif', 'bmp'].includes(ext)) {
                previewContent = `<img src="${attachmentUrl}" alt="${escapeHtml(filename)}">`;
            } else if (ext === 'pdf' || contentType.includes('pdf')) {
                previewContent = `<iframe src="${attachmentUrl}"></iframe>`;
            } else if (['docx', 'xlsx', 'csv'].includes(ext)) {
                // These need parsing - fetch and parse
                previewContent = await parseAttachmentForPreview(index, ext);
            } else {
                previewContent = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìÑ</div>
                        <div>${escapeHtml(filename)}</div>
                        <div style="font-size: 12px; margin-top: 8px;">Preview not available for this file type</div>
                        <button class="btn btn-primary" style="margin-top: 16px;" onclick="downloadAttachment(${index})">‚¨á Download File</button>
                    </div>`;
            }

            previewArea.innerHTML = `
                <div class="attachment-preview-container">
                    <div class="attachment-preview-header">
                        <span class="attachment-preview-title">üìé ${escapeHtml(filename)}</span>
                        <button class="attachment-preview-close" onclick="closeAttachmentPreview()">√ó</button>
                    </div>
                    <div class="attachment-preview-content">
                        ${previewContent}
                    </div>
                </div>`;

            // Scroll to preview
            previewArea.scrollIntoView({ behavior: 'smooth' });
        }

        async function parseAttachmentForPreview(index, ext) {
            try {
                // Fetch the attachment
                const response = await fetch(`/api/preview/attachment/${currentEmlCache}/${index}`);
                const blob = await response.blob();
                const file = new File([blob], `attachment.${ext}`);

                // Parse it
                const formData = new FormData();
                formData.append('file', file);

                const parseResponse = await fetch('/api/preview/parse', {
                    method: 'POST',
                    body: formData
                });
                const data = await parseResponse.json();

                if (data.success && data.html) {
                    return data.html;
                }
                return '<div style="padding: 20px;">Could not parse attachment</div>';
            } catch (e) {
                return `<div style="padding: 20px;">Error: ${e.message}</div>`;
            }
        }

        function closeAttachmentPreview() {
            const previewArea = document.getElementById('attachmentPreviewArea');
            if (previewArea) previewArea.innerHTML = '';
            document.querySelectorAll('.attachment-item').forEach(el => el.classList.remove('active'));
        }

        function downloadAttachment(index) {
            if (!currentEmlCache || !currentAttachments[index]) return;

            const att = currentAttachments[index];
            const url = `/api/preview/attachment/${currentEmlCache}/${index}`;

            const a = document.createElement('a');
            a.href = url;
            a.download = att.filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function getAttachmentIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'pdf': 'üìï',
                'docx': 'üìò', 'doc': 'üìò',
                'xlsx': 'üìó', 'xls': 'üìó',
                'csv': 'üìä',
                'png': 'üñºÔ∏è', 'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'gif': 'üñºÔ∏è',
                'txt': 'üìù',
                'zip': 'üì¶', 'rar': 'üì¶'
            };
            return icons[ext] || 'üìé';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updatePageIndicator() {
            // Simple page tracking based on scroll position
            const containers = document.querySelectorAll('.page-wrapper');
            if (!containers.length) return;

            const viewportRect = documentViewport.getBoundingClientRect();
            const viewportMid = viewportRect.top + viewportRect.height / 2;

            let currentPage = 1;
            containers.forEach((container, idx) => {
                const rect = container.getBoundingClientRect();
                if (rect.top < viewportMid && rect.bottom > viewportMid) {
                    currentPage = idx + 1;
                }
            });

            document.getElementById('pageIndicatorHeader').textContent = `Page ${currentPage} of ${containers.length}`;
        }

        // ============================================
        // FIELD EXTRACTION
        // ============================================
        document.getElementById('extractBtn').addEventListener('click', async () => {
            if (!currentFile) {
                setStatus('Please upload a document first');
                return;
            }

            setStatus('Extracting fields...');

            try {
                const response = await fetch(`/api/review/document/${currentDocIndex}/extract`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success && data.fields) {
                    extractedFields = data.fields;
                    renderFields();
                    updateStatistics();
                    setStatus(`Extracted ${Object.keys(extractedFields).length} fields`);
                } else {
                    setStatus(`Extraction error: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                setStatus(`Error: ${error.message}`);
            }
        });

        // ============================================
        // RENDER FIELDS - Single Consolidated Card
        // ============================================

        // Helper to format complex values (arrays, objects) into readable strings
        function formatFieldValue(value) {
            if (value === null || value === undefined) return '(empty)';
            if (typeof value === 'string') return value || '(empty)';
            if (typeof value === 'number' || typeof value === 'boolean') return String(value);

            // Handle arrays
            if (Array.isArray(value)) {
                if (value.length === 0) return '(empty array)';
                // If array of objects, extract meaningful strings
                const formatted = value.map(item => {
                    if (typeof item === 'object' && item !== null) {
                        // Try common field names for educational/experience entries
                        const parts = [];
                        if (item.degree || item.Degree) parts.push(item.degree || item.Degree);
                        if (item.institution || item.Institution || item.school || item.School)
                            parts.push(item.institution || item.Institution || item.school || item.School);
                        if (item.year || item.Year || item.date || item.Date)
                            parts.push(item.year || item.Year || item.date || item.Date);
                        if (item.title || item.Title || item.name || item.Name)
                            parts.push(item.title || item.Title || item.name || item.Name);
                        if (item.value || item.Value) parts.push(item.value || item.Value);

                        if (parts.length > 0) return parts.join(' - ');
                        // Fallback: stringify first few keys
                        const keys = Object.keys(item).slice(0, 3);
                        return keys.map(k => `${k}: ${item[k]}`).join(', ');
                    }
                    return String(item);
                });
                return formatted.join('; ');
            }

            // Handle objects
            if (typeof value === 'object') {
                // Try to extract meaningful info
                const parts = [];
                for (const key of Object.keys(value).slice(0, 5)) {
                    const v = value[key];
                    if (typeof v === 'string' || typeof v === 'number') {
                        parts.push(`${key}: ${v}`);
                    } else if (Array.isArray(v)) {
                        parts.push(`${key}: [${v.length} items]`);
                    }
                }
                if (parts.length > 0) return parts.join(', ');
                // Ultimate fallback
                try {
                    return JSON.stringify(value).substring(0, 200);
                } catch (e) {
                    return '(complex object)';
                }
            }

            return String(value);
        }

        function renderFields() {
            if (!extractedFields || Object.keys(extractedFields).length === 0) {
                fieldsCard.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <div>No fields extracted</div>
                    </div>`;
                return;
            }

            let html = '';
            for (const [name, field] of Object.entries(extractedFields)) {
                // Get the raw value
                let rawValue;
                if (typeof field === 'object' && field !== null) {
                    rawValue = field.value !== undefined ? field.value : field;
                } else {
                    rawValue = field;
                }

                // Format for display
                const displayValue = formatFieldValue(rawValue);
                const confidence = typeof field === 'object' ? (field.confidence || 0.95) : 0.95;
                const confPercent = Math.round(confidence * 100);
                const confClass = confidence >= 0.95 ? 'conf-high' : confidence >= 0.80 ? 'conf-medium' : 'conf-low';

                // Escape for onclick
                const escapedValue = displayValue.replace(/'/g, "\\'").replace(/"/g, "&quot;");

                html += `
                    <div class="field-row" data-field="${name}" onclick="findInDocument('${name}', '${escapedValue}')">
                        <span class="field-name">${name}</span>
                        <span class="field-value">${displayValue}</span>
                        <span class="field-confidence ${confClass}">${confPercent}%</span>
                        <div class="field-actions">
                            <button class="action-btn" onclick="event.stopPropagation(); editField('${name}')" title="Edit">‚úèÔ∏è</button>
                            <button class="action-btn" onclick="event.stopPropagation(); deleteField('${name}')" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>`;
            }
            fieldsCard.innerHTML = html;
        }

        // ============================================
        // UPDATE STATISTICS
        // ============================================
        function updateStatistics() {
            let total = 0, nullCount = 0, high = 0, medium = 0, low = 0;

            for (const [name, field] of Object.entries(extractedFields)) {
                total++;
                const value = typeof field === 'object' ? field.value : field;
                const confidence = typeof field === 'object' ? (field.confidence || 0.95) : 0.95;

                if (!value || value === '' || value === 'null' || value === 'N/A') nullCount++;
                if (confidence >= 0.95) high++;
                else if (confidence >= 0.80) medium++;
                else low++;
            }

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statNull').textContent = nullCount;
            document.getElementById('statHigh').textContent = high;
            document.getElementById('statMedium').textContent = medium;
            document.getElementById('statLow').textContent = low;
        }

        // ============================================
        // FIND IN DOCUMENT - Click Field to Search
        // ============================================
        function findInDocument(fieldName, fieldValue) {
            // Set active state
            document.querySelectorAll('.field-row').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-field="${fieldName}"]`)?.classList.add('active');

            if (!fieldValue || fieldValue === '(empty)') {
                setStatus(`Field "${fieldName}" has no value to search`);
                return;
            }

            // Get search text - use first significant word or first 20 chars
            let searchText = fieldValue.toString().trim();
            if (searchText.startsWith('[') || searchText.startsWith('{')) {
                // For JSON, extract first string value
                const match = searchText.match(/"([^"]+)"/);
                if (match) searchText = match[1];
            }
            searchText = searchText.split(/[\s,;]+/)[0].substring(0, 30).toLowerCase();

            if (searchText.length < 2) {
                setStatus(`Field "${fieldName}" value too short to search`);
                return;
            }

            // Remove existing highlights
            document.querySelectorAll('.search-highlight').forEach(el => el.remove());

            // Search in text layers
            const textSpans = document.querySelectorAll('.text-layer span');
            let found = false;

            for (const span of textSpans) {
                if (span.dataset.text && span.dataset.text.includes(searchText)) {
                    // Create highlight using stored PDF coordinates
                    const highlight = document.createElement('div');
                    highlight.className = 'search-highlight';

                    const pageWrapper = span.closest('.page-wrapper');
                    const textLayer = span.closest('.text-layer');

                    if (pageWrapper && textLayer) {
                        // Use stored coordinates from PDF for accurate positioning
                        const x = parseFloat(span.dataset.x) || parseFloat(span.style.left);
                        const y = parseFloat(span.dataset.y) || parseFloat(span.style.top);
                        const h = parseFloat(span.dataset.h) || parseFloat(span.style.fontSize) || 14;
                        const w = parseFloat(span.dataset.w) || span.textContent.length * 8;

                        // Position the highlight directly using PDF coordinates
                        highlight.style.left = (x - 2) + 'px';
                        highlight.style.top = (y - 2) + 'px';
                        highlight.style.width = Math.max(w + 4, 50) + 'px';
                        highlight.style.height = (h + 4) + 'px';

                        // Append to text layer (which is positioned over the canvas)
                        textLayer.appendChild(highlight);

                        // Scroll into view - scroll the viewport to show this page
                        pageWrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });

                        // Also scroll the highlight into the visible area
                        setTimeout(() => {
                            highlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);

                        // Remove highlight after 6 seconds
                        setTimeout(() => highlight.remove(), 6000);

                        found = true;
                        setStatus(`Found "${searchText}" in document`);
                        break;
                    }
                }
            }
            if (!found) {
                // Try browser find as fallback (Ctrl+F)
                setStatus(`Searching for "${searchText}"...`);
                if (window.find) {
                    window.find(searchText.substring(0, 20), false, false, true);
                }
            }
        }

        // ============================================
        // FIELD CRUD OPERATIONS
        // ============================================
        function editField(fieldName) {
            const currentValue = extractedFields[fieldName]?.value || extractedFields[fieldName] || '';
            const newValue = prompt(`Edit "${fieldName}":`, currentValue);
            if (newValue !== null) {
                if (typeof extractedFields[fieldName] === 'object') {
                    extractedFields[fieldName].value = newValue;
                } else {
                    extractedFields[fieldName] = { value: newValue, confidence: 0.95 };
                }
                renderFields();
                updateStatistics();
                setStatus(`Updated "${fieldName}"`);
            }
        }

        function deleteField(fieldName) {
            if (confirm(`Delete field "${fieldName}"?`)) {
                delete extractedFields[fieldName];
                renderFields();
                updateStatistics();
                setStatus(`Deleted "${fieldName}"`);
            }
        }

        function addNewField() {
            const name = prompt('Enter field name:');
            if (!name) return;
            const value = prompt('Enter field value:');
            extractedFields[name] = { value: value || '', confidence: 1.0 };
            renderFields();
            updateStatistics();
            setStatus(`Added "${name}"`);
        }

        // ============================================
        // APPROVE / REJECT
        // ============================================
        document.getElementById('approveBtn').addEventListener('click', () => {
            if (!currentFile) return;
            setStatus('‚úÖ Document Approved - saving...');
            // TODO: API call to save to approved folder
        });

        document.getElementById('rejectBtn').addEventListener('click', () => {
            if (!currentFile) return;
            setStatus('‚ùå Document Rejected');
            // TODO: API call to save to rejected folder
        });

        // ============================================
        // UTILITY
        // ============================================
        function setStatus(message) {
            statusText.textContent = message;
            console.log('[Status]', message);
        }

        // ============================================
        // AZURE STORAGE INTEGRATION
        // ============================================
        let selectedAzureFile = null;
        let azureContainers = [];

        // Azure Storage Button Click Handler
        document.getElementById('azureStorageBtn').addEventListener('click', openAzureModal);

        async function openAzureModal() {
            const modal = document.getElementById('azureModal');
            const loading = document.getElementById('azureLoading');
            const content = document.getElementById('azureContent');
            const error = document.getElementById('azureError');

            modal.classList.add('active');
            loading.style.display = 'flex';
            content.style.display = 'none';
            error.style.display = 'none';
            selectedAzureFile = null;
            updateSelectedFileInfo();

            try {
                const response = await fetch('/api/azure/containers');
                const data = await response.json();

                if (data.success) {
                    azureContainers = data.containers;
                    populateContainerSelect(data.containers);
                    loading.style.display = 'none';
                    content.style.display = 'block';
                } else {
                    throw new Error(data.error || 'Failed to load containers');
                }
            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.innerHTML = `
                    <div>‚ö†Ô∏è ${err.message}</div>
                    <div style="font-size: 11px; margin-top: 8px;">
                        Make sure Azure Storage is configured in Settings
                    </div>
                `;
            }
        }

        function closeAzureModal() {
            document.getElementById('azureModal').classList.remove('active');
        }

        function populateContainerSelect(containers) {
            const select = document.getElementById('containerSelect');
            select.innerHTML = '<option value="">-- Select a container --</option>';
            containers.forEach(c => {
                const option = document.createElement('option');
                option.value = c.name;
                option.textContent = c.name;
                select.appendChild(option);
            });
        }

        async function loadContainerBlobs() {
            const containerName = document.getElementById('containerSelect').value;
            const blobList = document.getElementById('blobList');

            if (!containerName) {
                blobList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">Select a container to view files</div>';
                return;
            }

            blobList.innerHTML = '<div class="azure-loading"><div class="azure-loading-spinner"></div><span>Loading files...</span></div>';

            try {
                const response = await fetch(`/api/azure/blobs/${encodeURIComponent(containerName)}`);
                const data = await response.json();

                if (data.success) {
                    if (data.blobs.length === 0) {
                        blobList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">No files in this container</div>';
                        return;
                    }

                    // Filter to supported file types
                    const supportedTypes = ['pdf', 'docx', 'xlsx', 'eml', 'csv', 'png', 'jpg', 'jpeg'];
                    const filteredBlobs = data.blobs.filter(blob => {
                        const ext = blob.name.split('.').pop().toLowerCase();
                        return supportedTypes.includes(ext);
                    });

                    if (filteredBlobs.length === 0) {
                        blobList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">No supported files found (PDF, DOCX, XLSX, EML, CSV, Images)</div>';
                        return;
                    }

                    blobList.innerHTML = filteredBlobs.map(blob => `
                        <div class="azure-file-item" onclick="selectAzureFile('${containerName}', '${blob.name}', ${blob.size})" data-blob="${blob.name}">
                            <span class="azure-file-icon">${getFileIcon(blob.name)}</span>
                            <span class="azure-file-name">${blob.name}</span>
                            <span class="azure-file-size">${formatFileSize(blob.size)}</span>
                        </div>
                    `).join('');
                } else {
                    throw new Error(data.error || 'Failed to load files');
                }
            } catch (err) {
                blobList.innerHTML = `<div style="padding: 20px; text-align: center; color: var(--tron-orange);">Error: ${err.message}</div>`;
            }
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'pdf': 'üìï',
                'docx': 'üìò',
                'doc': 'üìò',
                'xlsx': 'üìó',
                'xls': 'üìó',
                'csv': 'üìä',
                'eml': 'üìß',
                'png': 'üñºÔ∏è',
                'jpg': 'üñºÔ∏è',
                'jpeg': 'üñºÔ∏è'
            };
            return icons[ext] || 'üìÑ';
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function selectAzureFile(container, blobName, size) {
            // Remove previous selection
            document.querySelectorAll('.azure-file-item').forEach(el => el.classList.remove('selected'));

            // Add selection to clicked item
            const item = document.querySelector(`.azure-file-item[data-blob="${blobName}"]`);
            if (item) item.classList.add('selected');

            selectedAzureFile = { container, blobName, size };
            updateSelectedFileInfo();
        }

        function updateSelectedFileInfo() {
            const info = document.getElementById('selectedFileInfo');
            const btn = document.getElementById('loadAzureFileBtn');

            if (selectedAzureFile) {
                info.textContent = `Selected: ${selectedAzureFile.blobName}`;
                info.style.color = 'var(--tron-cyan)';
                btn.disabled = false;
            } else {
                info.textContent = 'No file selected';
                info.style.color = 'var(--text-secondary)';
                btn.disabled = true;
            }
        }

        async function loadSelectedAzureFile() {
            if (!selectedAzureFile) return;

            const { container, blobName } = selectedAzureFile;
            setStatus(`Loading ${blobName} from Azure...`);
            closeAzureModal();

            try {
                const response = await fetch(`/api/azure/download/${encodeURIComponent(container)}/${encodeURIComponent(blobName)}`);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Download failed');
                }

                const blob = await response.blob();
                const file = new File([blob], blobName, { type: blob.type });

                currentFile = file;
                docInfo.textContent = blobName + ' (Azure)';

                // Upload to review system
                const formData = new FormData();
                formData.append('files', file);

                const uploadResponse = await fetch('/api/review/add', {
                    method: 'POST',
                    body: formData
                });
                const uploadData = await uploadResponse.json();

                if (uploadData.success) {
                    currentDocIndex = (uploadData.total || 1) - 1;
                    setStatus(`Loaded: ${blobName} from Azure (index ${currentDocIndex})`);
                }

                // Preview the file
                await loadDocumentPreview(file);

            } catch (err) {
                setStatus(`Error: ${err.message}`);
                console.error('Azure download error:', err);
            }
        }

        // Close modal on overlay click
        document.getElementById('azureModal').addEventListener('click', (e) => {
            if (e.target.id === 'azureModal') {
                closeAzureModal();
            }
        });

        // Start animation on load
        runStartupSequence();
    </script>
</body>

</html>